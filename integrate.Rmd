---
title: "integrate"
author: "Natalya"
date: "2025-12-10"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
library(readxl)
library(dplyr)
library(gtsummary)
library(tidyr)
library(gtsummary)
library(ggplot2)
library(mice)
library(tidyverse)
library(naniar)
library(VIM)
```
# Part 1  
```{r}
data <- read_excel("diabrain.xlsx")

data <- data %>%
  mutate(Treatment = recode(Treatment,
                            "1" = "метформин",
                            "2" = "SGLT2i",
                            "3" = "SGLT2i", 
                            "7" = "SGLT2i",
                            "4" = "GLP1",
                            "51" = "GLP1",
                            "52" = "GLP1",
                            "6" = "GLP1",
                            "5" = "GLP1",
                            "8" = "GLP1"
  )) 


data$Age[is.na(data$Age)] <- "69"
data <- data %>% 
  mutate(Age = as.numeric(Age))

data$Treatment <- as.factor(data$Treatment)
data$Sex <- as.factor(data$Sex)


data$`HbA1c level` <- as.factor(data$`HbA1c level`)

tbl <- data %>%
  tbl_summary(include = `HbA1c 0`)
tbl

replacement_df <- data.frame(
  ID = c(136, 149, 154, 163, 215, 231, 238),
  New_DM_Duration = c(10, 8, 16, 8, 6, 10, 7)
)

duration <- summary(data$`DM duration`)
print(duration)


data <- data %>%
  left_join(replacement_df, by = "ID") %>%
  mutate(`DM duration` = ifelse(is.na(`DM duration`) & !is.na(New_DM_Duration), 
                                New_DM_Duration, 
                                `DM duration`)) %>%
  select(-New_DM_Duration) 

data$`DM duration`[data$`DM duration` == 0] <- 1

HH <- summary(data$`HbA1c 0`)
print(HH)

data$`HbA1c 0`[data$`HbA1c 0` == 45327.0] <- 6
data$`HbA1c 0`[data$`HbA1c 0` == NA] <- 10

data <- data %>%
  mutate(`HbA1c 0` = replace(`HbA1c 0`, is.na(`HbA1c 0`), 10))

HH3 <- summary(data$`HbA1c 3`)
print(HH3)

data$`HbA1c 6` <- as.numeric(data$`HbA1c 6`)

HH6 <- summary(data$`HbA1c 6`)
print(HH6)

data$`HbA1c 9` <- as.numeric(data$`HbA1c 9`)

data$`HbA1c 9`[data$`HbA1c 9` == 45296.0] <- 5
data$`HbA1c 9`[data$`HbA1c 9` == 45298.0] <- 6.5

HH9 <- summary(data$`HbA1c 9`)
print(HH9)

data$`HbA1c 12` <- as.numeric(data$`HbA1c 12`)
data$`HbA1c 12`[data$`HbA1c 12` == 45298.0] <- 6.0
HH12 <- summary(data$`HbA1c 12`)
print(HH12)

NSE0 <- summary(data$`NSE 0`)
print(NSE0)

NSE6 <- summary(data$`NSE 6`)
print(NSE6)

NSE12 <- summary(data$`NSE 12`)
print(NSE12)

Lc0 <- summary(data$`NSE 12`)
print(NSE12)


data$`S100 0`[data$`S100 0` == 0.02] <- 20
data$`S100 0`[data$`S100 0` == 0.03] <- 30

data$`S100 3`[data$`S100 3` == 0.03] <- 30

data$`S100 6`[data$`S100 6` == 0.05] <- 50

data$`S100 12`[data$`S100 6` == 0.01] <- 10

data$`LDL 0` <- as.numeric(data$`LDL 0`)

data$`TG 0` <- as.numeric(data$`TG 0`)

```
```{r}
hrt_index <- which(colnames(data) == "HRT")

if (length(hrt_index) > 0) {

  data_1 <- data[, 1:(hrt_index - 1), drop = FALSE]
} else {
  warning("Столбец 'HRT' не найден")
  data_1 <- data
}
```
# Part 2 
```{r}
data$`Сardiac ischemia`[data$ID == 152] <- 0

data$Alcohol[data$ID == 205] <- 1

data$Anticoagulants[data$ID == 266] <- NA

data$`Hypertension duration`[data$ID %in% c(127, 179, 181, 222)] <- NA

data$Hypertension[data$ID == 215] <- 1

data$`Hypertension duration`[data$ID %in% c(142, 168)] <- NA

data <- data %>% 
  mutate(
    across(c(HRT, Hypertension, `Сardiac ischemia`, Stroke, Polineuropathy, Retinopathy, Smoking, Alcohol, `ACE inhibitors`, ARB, BB, `Calcium channel blockers`, Aspirin, Diuretics, Statin, Anticoagulants), ~as.factor(.)),
    `Hypertension duration` = as.numeric(`Hypertension duration`)
    )

data <- data %>% 
  mutate(
    `Hypertension duration` = case_when(
      Hypertension == 0 & is.na(`Hypertension duration`) ~ 0,
      TRUE ~ `Hypertension duration`
    )
  )

```
```{r}
data_2 <- subset(data, select = c("ID", "HRT", "Hypertension", 
                                 "Hypertension duration", "Сardiac ischemia", 
                                 "Stroke", "Polineuropathy", "Retinopathy", 
                                 "Smoking", "Alcohol", "ACE inhibitors", 
                                 "ARB", "BB", "Calcium channel blockers", 
                                 "Aspirin", "Diuretics", "Statin", 
                                 "Anticoagulants"))
```
# Part 3 

```{r}
df_p3 <- read_excel("diabrain.xlsx")
df_p3 <- df_p3 %>%
  select(1, 50:71, -65) %>% 
  mutate(across(c(2:12, 17:22), ~ round(as.numeric(.), 2)),  
         across(c(13:16), as.factor),
         across(1, as.numeric))
summary(df_p3) 
df_p3 <- df_p3 %>%
  mutate(Height = if_else(Height == 1, NA, Height), 
         `BMI 0` = if_else(`BMI 0` == 0, NA, `BMI 0`), 
         `BMI 6` = if_else(`BMI 6` == 0, NA, `BMI 6`),
         `BMI 12` = if_else(`BMI 12` == 45770, 23.40, `BMI 12`), 
         `Creatinine 6` = if_else(`ID` == 198, 111, `Creatinine 6`), 
         `GFR 6` = if_else(`ID` == 184, 101, `GFR 6`),
         `GFR 6` = if_else(`ID` == 198, 68, `GFR 6`), 
         `GFR 12` = if_else(`ID` == 250, NA, `GFR 6`)) 
summary(df_p3) 

#df_p3$ID <- as.numeric(as.character(df_p3$ID))
```

# Part 4 
```{r}
file_path <- "diabrain.xlsx"
df_brain <- read_excel(file_path)

moca_start <- 72
df_moca <- df_brain[, moca_start:ncol(df_brain)]

df_moca <- df_brain %>%
  select(ID, Treatment, moca_start:ncol(df_brain))

df_moca <- df_moca %>%
  mutate(Treatment = recode(Treatment,
                            "1" = "метформин",
                            "2" = "SGLT2i",
                            "3" = "SGLT2i", 
                            "7" = "SGLT2i",
                            "4" = "GLP1",
                            "51" = "GLP1",
                            "52" = "GLP1",
                            "6" = "GLP1",
                            "5" = "GLP1",
                            "8" = "GLP1"
  )) 

df_moca <- df_moca %>%
  mutate(across(
    c(`MOCA 0`, `MOCA 3`, `MOCA 6`, `MOCA 9`, `MOCA 12`),
    ~ ifelse(. == 0, NA, .)
  ))

df_moca <- df_moca %>%
  mutate(across(
    where(is.character) & !matches("^Treatment$"),
    ~ suppressWarnings(as.numeric(gsub(",", ".", .)))
  ))

df_num <- df_moca[, sapply(df_moca, is.numeric)]

stats_df <- data.frame(
  variable = names(df_num),
  mean = sapply(df_num, function(x) round(mean(x, na.rm = TRUE), 2)),
  sd   = sapply(df_num, function(x) round(sd(x,   na.rm = TRUE), 2)),
  min  = sapply(df_num, function(x) round(min(x,  na.rm = TRUE), 2)),
  max  = sapply(df_num, function(x) round(max(x,  na.rm = TRUE), 2)),
  missing_n = sapply(df_num, function(x) sum(is.na(x))),
  missing_pct = sapply(df_num, function(x) round(mean(is.na(x)) * 100, 2)),
  stringsAsFactors = FALSE
)

stats_df

write.csv(stats_df,
          "stats_overall.csv",
          row.names = FALSE,
          fileEncoding = "UTF-8")

safe_stat <- function(x, fun) {
  x <- x[!is.na(x)]
  if (length(x) == 0) return(NA_real_)
  fun(x)
}

stats_by_treat <- df_moca %>%
  pivot_longer(
    cols = -Treatment,
    names_to  = "scale",
    values_to = "value"
  ) %>%
  group_by(Treatment, scale) %>%
  summarise(
    n           = sum(!is.na(value)),
    missing_n   = sum(is.na(value)),
    missing_pct = round(100 * missing_n / (n + missing_n), 1),
    
    mean   = round(safe_stat(value, mean),   2),
    sd     = round(safe_stat(value, sd),     2),
    median = round(safe_stat(value, median), 2),
    iqr    = round(safe_stat(value, IQR),    2),
    min    = round(safe_stat(value, min),    2),
    max    = round(safe_stat(value, max),    2),
    
    .groups = "drop"
  )


stats_by_treat
```
```{r}
df_moca1 <- df_moca %>%
  select(-Treatment)
```

```{r}
merged_data <- data_1 %>%
  left_join(data_2, by = "ID") %>%
  left_join(df_p3, by = "ID") %>% 
  left_join(select(df_moca, -Treatment), by = "ID")
openxlsx::write.xlsx(merged_data, "~/Desktop/Biostatistics/Project/merged_data.xlsx")
```

# Visualisation

## Gender distribution in treatment groups

```{r}
ggplot(merged_data, aes(x = Treatment, fill = Sex)) +
  geom_bar(width = 0.5, position = position_dodge(width = 0.6), alpha = 0.6) +
  labs(
    x = "Treatment Group",
    y = "Number of Patients",
    title = "Distribution of Patients by Sex in Treatment Groups") +
  scale_fill_manual(name = "Sex",
                    labels = c("0" = "Female",
                               "1" = "Male"),
                    values = c("0" = "pink",
                               "1" = "blue")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```

## Distribution by duration of diabetes mellitus in treatment groups
```{r}
ggplot(merged_data, aes(y = `DM duration`, x = Treatment, fill = Treatment)) +
  geom_boxplot(width = 0.5, alpha = 0.8, color = "gray40", 
               outlier.color = "gray30", outlier.shape = 16) +
  scale_fill_brewer(palette = "Set2") + 
  labs(
    x = "Treatment Group",
    y = "Diabetes Duration, years",
    title = "Distribution of Patients by Diabetes Duration in Treatment Groups"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none",  
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  )
```

```{r}
ggplot(merged_data, aes(y = `Age`, x = Treatment, fill = Treatment)) +
  geom_boxplot(width = 0.5, alpha = 0.8, color = "gray40", 
               outlier.color = "gray30", outlier.shape = 16) +
  scale_fill_brewer(palette = "Set2") + 
  labs(
    x = "Treatment Group",
    y = "Age, years",
    title = "Distribution of patients by age in treatment groups"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none",  
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  )
```

## HbA1c by visits

```{r}
HbA1c_long <- merged_data %>%
  select(Treatment, `HbA1c 0`, `HbA1c 3`, `HbA1c 6`, `HbA1c 9`, `HbA1c 12`) %>% 
  pivot_longer(cols = c(`HbA1c 0`, `HbA1c 3`, `HbA1c 6`, `HbA1c 9`, `HbA1c 12`),
               names_to = "month",
               values_to = "HbA1c") %>%
  mutate(month = gsub("HbA1c ", "", month),
         month = factor(month, levels = c("0", "3", "6", "9", "12")))

ggplot(HbA1c_long, aes(x = month, y = HbA1c)) +
  geom_boxplot() +
  labs(
    x = "Month",
    y = "Glycated hemoglobin, %",
    title = "Glycated hemoglobin by visit"
  ) +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
ggplot(HbA1c_long, aes(x = month, y = HbA1c, fill = Treatment)) +
  geom_boxplot(position = position_dodge(width = 0.8), 
               alpha = 0.8, color = "gray30") +
  scale_fill_brewer(palette = "Set2", name = "Treatment") +
  labs(
    x = "Month",
    y = "HbA1c, %",
    title = "Dynamics of glycated hemoglobin by visit and treatment group"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    legend.position = "right",
    panel.grid.major = element_line(color = "gray85"),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "gray70", fill = NA, size = 0.5)
  )
```

```{r}
HbA1c_summary <- HbA1c_long %>%
  group_by(Treatment, month) %>%
  summarise(
    mean_HbA1c = mean(HbA1c, na.rm = TRUE),
    se = sd(HbA1c, na.rm = TRUE) / sqrt(n()),
    .groups = 'drop'
  )

ggplot(HbA1c_summary, aes(x = month, y = mean_HbA1c, 
                           group = Treatment, color = Treatment)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_HbA1c - se, ymax = mean_HbA1c + se), 
                width = 0.1, size = 0.8) +
  labs(
    x = "Month",
    y = "HbA1c, %",
    title = "Dynamics of glycated hemoglobin by visit",
    color = "Treatment"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "bottom"
  )
```
## NSE (ng/ml) by visits
```{r}
NSE_long <- merged_data %>%
  select(Treatment,`NSE 0`, `NSE 3`, `NSE 6`, `NSE 12`) %>% 
  pivot_longer(cols = c(`NSE 0`, `NSE 3`, `NSE 6`, `NSE 12`),
               names_to = "month",
               values_to = "NSE") %>%
  mutate(month = gsub("NSE ", "", month),
         month = factor(month, levels = c("0", "3", "6", "12")))

ggplot(NSE_long, aes(x = month, y = NSE)) +
  geom_boxplot() +
  labs(
    x = "Month",
    y = "NSE, ng/ml",
    title = "Neuron-specific enolase levels by visit"
  ) +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
ggplot(NSE_long, aes(x = month, y = NSE, fill = Treatment)) +
  geom_boxplot(position = position_dodge(width = 0.8), 
               alpha = 0.8, color = "gray30") +
  scale_fill_brewer(palette = "Set2", name = "Treatment") +
  labs(
    x = "Month",
    y = "NSE, ng/ml",
    title = "Neuron-specific enolase levels by treatment group"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    legend.position = "right",
    panel.grid.major = element_line(color = "gray85"),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "gray70", fill = NA, size = 0.5)
  )
```

## Neurofilament light chains (ng/ml) by visit

```{r}
Lchains_long <- merged_data %>%
  select(Treatment, `Lchains 0`, `Lchains 3`, `Lchains 6`, `Lchains 12`) %>% 
  pivot_longer(cols = c(`Lchains 0`, `Lchains 3`, `Lchains 6`, `Lchains 12`),
               names_to = "month",
               values_to = "Lchains") %>%
  mutate(month = gsub("Lchains ", "", month),
         month = factor(month, levels = c("0", "3", "6", "12")))

ggplot(Lchains_long, aes(x = month, y = Lchains)) +
  geom_boxplot() +
  labs(
    x = "Month",
    y = "NfL, ng/ml",
    title = "Neurofilament light chain values by visit"
  ) +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
ggplot(Lchains_long, aes(x = month, y = Lchains, fill = Treatment)) +
  geom_boxplot(position = position_dodge(width = 0.8), 
               alpha = 0.8, color = "gray30") +
  scale_fill_brewer(palette = "Set2", name = "Treatment") +
  labs(
    x = "Observation month",
    y = "NfL, ng/ml",
    title = "Neurofilament light chain levels by treatment group"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    legend.position = "right",
    panel.grid.major = element_line(color = "gray85"),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "gray70", fill = NA, size = 0.5)
  )
```

## Protein S 100 (µg/ml) by visit
```{r}
S100_long <- merged_data %>%
  select(Treatment, `S100 0`, `S100 3`, `S100 6`, `S100 12`) %>% 
  pivot_longer(cols = c(`S100 0`, `S100 3`, `S100 6`, `S100 12`),
               names_to = "month",
               values_to = "S100") %>%
  mutate(month = gsub("S100 ", "", month),
         month = factor(month, levels = c("0", "3", "6", "12")))

ggplot(S100_long, aes(x = month, y = S100)) +
  geom_boxplot() +
  labs(
    x = "Month",
    y = "Protein S 100, µg/ml",
    title = "Protein S 100 values by visit"
  ) +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))
```
```{r}
ggplot(S100_long, aes(x = month, y = S100, fill = Treatment)) +
  geom_boxplot(position = position_dodge(width = 0.8), 
               alpha = 0.8, color = "gray30") +
  scale_fill_brewer(palette = "Set2", name = "Treatment") +
  labs(
    x = "Observation month",
    y = "S100, µg/ml",
    title = "S100 protein levels by treatment group"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    legend.position = "right",
    panel.grid.major = element_line(color = "gray85"),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "gray70", fill = NA, size = 0.5)
  )
```


## BMI
```{r}
BMI_long <- merged_data %>%
  select(ID, Treatment, `BMI 0`, `BMI 3`, `BMI 6`, `BMI 9`, `BMI 12`) %>% 
  pivot_longer(cols = c(`BMI 0`, `BMI 3`, `BMI 6`, `BMI 9`, `BMI 12`),
               names_to = "month",
               values_to = "BMI") %>%
  mutate(month = gsub("BMI ", "", month),
         month = factor(month, levels = c("0", "3", "6", "9", "12")))

ggplot(BMI_long, aes(x = month, y = BMI, fill = Treatment)) +
  geom_boxplot(position = position_dodge(width = 0.8), 
               alpha = 0.8, color = "gray30") +
  scale_fill_brewer(palette = "Set2", name = "Treatment") +
  labs(
    x = "Observation month",
    y = "BMI, kg/m²",
    title = "BMI dynamics by visit and treatment group"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    legend.position = "right",
    panel.grid.major = element_line(color = "gray85"),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "gray70", fill = NA, size = 0.5)
  )
```
## MOCA
```{r}
MOCA_long <- merged_data %>%
  select(Treatment, `MOCA 0`, `MOCA 3`, `MOCA 6`, `MOCA 9`, `MOCA 12`) %>% 
  pivot_longer(cols = c(`MOCA 0`, `MOCA 3`, `MOCA 6`, `MOCA 9`, `MOCA 12`),
               names_to = "month",
               values_to = "MOCA") %>%
  mutate(month = gsub("MOCA ", "", month),
         month = factor(month, levels = c("0", "3", "6", "9", "12")))

ggplot(MOCA_long, aes(x = month, y = MOCA, fill = Treatment)) +
  geom_boxplot(position = position_dodge(width = 0.8), 
               alpha = 0.8, color = "gray30") +
  scale_fill_brewer(palette = "Set2", name = "Treatment") +
  labs(
    x = "Observation month",
    y = "MOCA scale, points",
    title = "Distribution of Montreal Cognitive Assessment scores by visit and treatment group"
  ) +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.3))
```

## Missing data patterns
```{r fig.width = 8, fig.height = 10, results='asis'}

data_renamed <- data

colnames(data_renamed)[colnames(data_renamed) == "HbA1c 0"] <- "HbA1c_00"
colnames(data_renamed)[colnames(data_renamed) == "HbA1c 3"] <- "HbA1c_03"
colnames(data_renamed)[colnames(data_renamed) == "HbA1c 6"] <- "HbA1c_06"
colnames(data_renamed)[colnames(data_renamed) == "HbA1c 9"] <- "HbA1c_09"
colnames(data_renamed)[colnames(data_renamed) == "HbA1c 12"] <- "HbA1c_12"
vars_of_interest <- c("HbA1c_00", "HbA1c_03", "HbA1c_06", "HbA1c_09", "HbA1c_12")

data_subset <- data_renamed[, vars_of_interest, drop = FALSE]

colnames(data_subset) <- c("Hb_00", "Hb_03", "Hb_06", "Hb_09", "Hb_12")

md_pattern_result <- md.pattern(data_subset, plot = TRUE)
title(main = "Паттерны пропущенных данных HbA1c", 
      line = 2, 
      cex.main = 1.2,
      adj = 0.5)

colnames(md_pattern_result)[1:5] <- c("Месяц 0", "Месяц 3", "Месяц 6", "Месяц 9", "Месяц 12")

print(md_pattern_result)
```
```{r fig.width = 8, fig.height = 10, results='asis'}
data_filtered <- subset(data, Treatment %in% c("SGLT2i", "GLP1"))

vars_of_interest <- c("HbA1c 0", "HbA1c 3", "HbA1c 6", "HbA1c 9", "HbA1c 12")
data_subset <- data_filtered[, vars_of_interest, drop = FALSE]

colnames(data_subset) <- c("Hb_00", "Hb_03", "Hb_06", "Hb_09", "Hb_12")

md_pattern_result <- md.pattern(data_subset, plot = TRUE)
title(main = "Паттерны пропущенных данных HbA1c в группах SGLT2i и GLP1", 
      line = 2, 
      cex.main = 1.2,
      adj = 0.5)

colnames(md_pattern_result)[1:5] <- c("Месяц 0", "Месяц 3", "Месяц 6", "Месяц 9", "Месяц 12")



print(md_pattern_result)
```

```{r}
naniar::miss_prop_summary(merged_data)
naniar::miss_var_summary(merged_data)
naniar::gg_miss_var(merged_data)
naniar::gg_miss_case(merged_data)
naniar::gg_miss_upset(merged_data)
```
```{r}
VIM::aggr(merged_data)
mice::md.pattern(merged_data)
```

```{r}
selected_data <- merged_data %>%
  select(-'Cholesterol 0', -'Cholesterol 6', -'Cholesterol 12', -'LDL 0', - 'LDL 6', -'LDL 12', - 'TG 0', -'TG 6', -'TG 12', -'Kidney disease', -'Kidney disease stage', -'Albuminuria', -'Creatinine 0', -'Creatinine 6', -'Creatinine 12', -'GFR0', -'GFR 6',-'GFR 12', -'Treatment', -'Polineuropathy investigator')
```



```{r}
naniar::add_any_miss(selected_data) |> 
    gtsummary::tbl_summary(
        by = any_miss_all
    ) |> 
    gtsummary::add_p()
```

```{r}
imp <- mice(
    selected_data,
    m = 10, 
    maxit = 10, 
    printFlag = FALSE, 
    seed = 42
)

imp$predictorMatrix
imp$method
```
